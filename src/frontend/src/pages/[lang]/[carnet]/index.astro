---
import ReadingLayout from '../../../layouts/ReadingLayout.astro';
import CalendarWidget from '../../../components/CalendarWidget.vue';
import ContentLanguageSwitcher from '../../../components/reading/ContentLanguageSwitcher.vue';
import ContinueReading from '../../../components/reading/ContinueReading.vue';
import FilterOverlay from '../../../components/filter/FilterOverlay.vue';
import OfflineDownload from '../../../components/pwa/OfflineDownload.vue';
import { getCarnets, getCarnetEntries, getEntry, hasTranslation, isCarnetCrossYear, getCarnetSummary, getEntryPreview } from '../../../lib/content';
import { DIARY_LANGUAGES, glossaryUrl, type DiaryLanguageConfig } from '../../../lib/diary-lang-config';
import { createT } from '../../../i18n/astro';

export function getStaticPaths() {
  const paths: { params: { lang: string; carnet: string }; props: { lang: DiaryLanguageConfig } }[] = [];

  for (const lang of DIARY_LANGUAGES) {
    // For translations: union of language-specific + original carnets (show all, even untranslated)
    // For original: just original carnets
    const langCarnets = getCarnets(lang.contentPath);
    const originalCarnets = getCarnets('_original');

    const allCarnetIds = lang.isTranslation
      ? [...new Set([...langCarnets.map(c => c.id), ...originalCarnets.map(c => c.id)])]
      : originalCarnets.map(c => c.id);

    // Exclude Carnet 000 - it has special handling in /[lang]/000/index.astro
    for (const carnetId of allCarnetIds.filter(id => id !== '000')) {
      paths.push({
        params: { lang: lang.urlPath, carnet: carnetId },
        props: { lang },
      });
    }
  }

  return paths;
}

interface Props {
  lang: DiaryLanguageConfig;
}

const { lang } = Astro.props;
const { carnet } = Astro.params;
const t = createT(lang.uiLocale);
const basePath = `/${lang.urlPath}`;

// Get carnet summary data (people, places, themes) — always from original
const summary = await getCarnetSummary(carnet!, '_original');

// Build entry list based on language type
let allEntries: Array<{ date: string; title: string; isTranslated?: boolean; preview?: string }>;

if (lang.isTranslation) {
  // Translation view: show all original entries, mark which are translated
  const langEntries = getCarnetEntries(carnet!, lang.contentPath);
  const originalEntries = getCarnetEntries(carnet!, '_original');

  // Handle naming mismatch (Carnet 000 edge case: section vs date naming)
  const langUsesSection = langEntries.length > 0 && /^\d{3}-\d{2}$/.test(langEntries[0]);
  const originalUsesSection = originalEntries.length > 0 && /^\d{3}-\d{2}$/.test(originalEntries[0]);
  const namingMismatch = langEntries.length > 0 && originalEntries.length > 0 &&
                         langUsesSection !== originalUsesSection;

  if (namingMismatch && langUsesSection) {
    // Use translated entries as primary (they're translated)
    allEntries = langEntries.map(entryId => {
      const entry = getEntry(carnet!, entryId, lang.contentPath);
      const preview = getEntryPreview(carnet!, entryId, lang.contentPath);
      return { date: entryId, title: entry?.title || entryId, isTranslated: true, preview };
    });
  } else {
    // Normal: show all original entries, mark translated ones
    allEntries = originalEntries.map(entryDate => {
      const isTranslated = langEntries.includes(entryDate);
      const contentLang = isTranslated ? lang.contentPath : '_original';
      const entry = getEntry(carnet!, entryDate, contentLang);
      const preview = getEntryPreview(carnet!, entryDate, contentLang);
      return { date: entryDate, title: entry?.title || entryDate, isTranslated, preview };
    });
  }
} else {
  // Original view: show only original entries, no translation tracking
  const entries = getCarnetEntries(carnet!, lang.contentPath);
  allEntries = entries.map(entryDate => {
    const entry = getEntry(carnet!, entryDate, lang.contentPath);
    const preview = getEntryPreview(carnet!, entryDate, lang.contentPath);
    return { date: entryDate, title: entry?.title || entryDate, preview };
  });
}

// Carnet info and navigation
const allOriginalCarnets = getCarnets('_original');
const langCarnets = getCarnets(lang.contentPath);
const carnetInfo = langCarnets.find(c => c.id === carnet) || allOriginalCarnets.find(c => c.id === carnet);

const navCarnets = allOriginalCarnets.filter(c => c.id !== '000').sort((a, b) => a.id.localeCompare(b.id));
const carnetIdx = navCarnets.findIndex(c => c.id === carnet);
const prevCarnet = carnetIdx > 0 ? navCarnets[carnetIdx - 1] : null;
const nextCarnet = carnetIdx < navCarnets.length - 1 ? navCarnets[carnetIdx + 1] : null;

// Check if section-based carnet
const isSectionCarnet = allEntries.length > 0 && /^\d{3}-\d{2}$/.test(allEntries[0]?.date || '');

// Translation stats (only for translation languages)
const translatedCount = lang.isTranslation ? allEntries.filter(e => e.isTranslated).length : 0;

// Year info for breadcrumb
const crossYear = isCarnetCrossYear(carnet!, '_original');
const primaryYear = crossYear.years[0];

// Calendar months
function getMonthsInRange(dateRange: { start: string; end: string }): Array<{ year: number; month: number }> {
  if (!dateRange.start || !dateRange.end) return [];
  const months: Array<{ year: number; month: number }> = [];
  const startDate = new Date(dateRange.start);
  const endDate = new Date(dateRange.end);
  let current = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
  const end = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
  while (current <= end) {
    months.push({ year: current.getFullYear(), month: current.getMonth() + 1 });
    current.setMonth(current.getMonth() + 1);
  }
  return months;
}
const calendarMonths = !isSectionCarnet ? getMonthsInRange(summary.dateRange) : [];

// Summary data
const topPeople = Object.entries(summary.peopleCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topPlaces = Object.entries(summary.placesCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topThemes = Object.entries(summary.themeCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

function formatDisplayName(id: string): string {
  return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

const formatEntryDate = (dateStr: string) => {
  if (/^\d{3}-\d{2}$/.test(dateStr)) {
    const section = parseInt(dateStr.split('-')[1], 10);
    return t('diary.section', { n: section });
  }
  const datePart = dateStr.split('-').slice(0, 3).join('-');
  const suffix = dateStr.split('-').slice(3).join('-');
  const date = new Date(datePart);
  let formatted = date.toLocaleDateString(lang.dateLocale, {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  });
  if (suffix) {
    const suffixMap: Record<string, string> = {
      'evening': t('diary.evening'),
      'morning': t('diary.morning'),
      'night': t('diary.night'),
    };
    formatted += ' ' + (suffixMap[suffix] || `(${suffix})`);
  }
  return formatted;
};

const diaryLabel = lang.isTranslation ? t('diary.diary') : 'Journal';

// Calendar widget language value
const calendarLanguage = lang.isTranslation ? lang.urlPath : 'original';

// Entry link: for translation, link to translated version if available, otherwise original
function entryHref(entry: typeof allEntries[0]): string {
  if (lang.isTranslation && !entry.isTranslated) {
    return `/original/${carnet}/${entry.date}`;
  }
  return `${basePath}/${carnet}/${entry.date}`;
}
---

<ReadingLayout title={`${t('diary.notebook')} ${carnet} — ${t('diary.pageTitle')}`} lang={lang.urlPath}>
  <div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm text-muted">
      <a href={basePath} class="hover:text-accent">{diaryLabel}</a>
      <span class="mx-2">&rsaquo;</span>
      {primaryYear ? (
        <>
          <a href={`${basePath}/${primaryYear}`} class="hover:text-accent">{primaryYear}</a>
          <span class="mx-2">&rsaquo;</span>
        </>
      ) : null}
      <span class="text-ink">{t('diary.notebook')} {carnet}</span>
    </nav>

    <!-- Header + Summary Grid -->
    <section class="mb-10">
      <div class="grid gap-5 grid-cols-1 sm:grid-cols-2 xl:grid-cols-[1.5fr_1fr_1fr_1fr]">
        <!-- Carnet Header (wider 1st column) -->
        <header class="summary-card p-5 rounded-lg flex flex-col justify-between">
          <div>
            {/* Prev/next carnet navigation in header */}
            <nav class="flex justify-between items-center mb-3 text-sm">
              {prevCarnet ? (
                <a href={`${basePath}/${prevCarnet.id}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                  </svg>
                  {t('diary.notebook')} {prevCarnet.id}
                </a>
              ) : <span />}
              {nextCarnet ? (
                <a href={`${basePath}/${nextCarnet.id}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
                  {t('diary.notebook')} {nextCarnet.id}
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              ) : <span />}
            </nav>

            <h1 class="text-3xl font-normal text-ink mb-3" style="font-family: var(--font-serif); text-shadow: 0 1px 2px rgba(44,24,16,0.08);">
              {t('diary.notebook')} {carnet}
            </h1>

            {carnetInfo?.dateRange ? (() => {
              const startYear = carnetInfo.dateRange.start.getFullYear();
              const endYear = carnetInfo.dateRange.end.getFullYear();
              const startMonth = carnetInfo.dateRange.start.toLocaleDateString(lang.dateLocale, { month: 'long' });
              const endMonth = carnetInfo.dateRange.end.toLocaleDateString(lang.dateLocale, { month: 'long' });
              return (
                <p class="text-ink-light mb-3">
                  {startMonth}{' '}
                  <a href={`${basePath}/${startYear}`} class="hover:text-accent transition-colors">{startYear}</a>
                  {' — '}
                  {endMonth}{' '}
                  <a href={`${basePath}/${endYear}`} class="hover:text-accent transition-colors">{endYear}</a>
                </p>
              );
            })() : carnet === '000' && (
              <p class="text-ink-light mb-3">{t('diary.preface')}</p>
            )}

            <div class="flex items-center gap-3 text-sm mb-3">
              <span class="text-muted">
                {allEntries.length} {isSectionCarnet ? t('diary.sections') : t('diary.entries')}
              </span>
              {lang.isTranslation && (
                <>
                  <span class="text-muted">&bull;</span>
                  <span class="text-accent">
                    {translatedCount} {t('diary.translated')}
                  </span>
                </>
              )}
            </div>

            {lang.isTranslation && translatedCount < allEntries.length && (
              <div class="mb-4">
                <div class="h-2 bg-sepia rounded-full overflow-hidden">
                  <div
                    class="h-full bg-accent rounded-full transition-all"
                    style={`width: ${(translatedCount / allEntries.length) * 100}%`}
                  />
                </div>
                <p class="text-xs text-muted mt-1">
                  {t('diary.completed', { percent: Math.round((translatedCount / allEntries.length) * 100) })}
                </p>
              </div>
            )}

            {summary.primaryLocation && (
              <p class="text-sm text-muted mb-2">
                {t('diary.mainLocation')} <a href={glossaryUrl(lang, summary.primaryLocation.toUpperCase().replace(/ /g, '_'))} class="text-ink hover:text-accent transition-colors">{formatDisplayName(summary.primaryLocation)}</a>
              </p>
            )}
          </div>

          <div class="flex flex-col gap-3 mt-4 w-full">
            <ContentLanguageSwitcher
              client:load
              currentLanguage={lang.urlPath}
              pathSuffix={`/${carnet}/`}
            />
            <ContinueReading
              client:load
              scopeType="carnet"
              scopeId={carnet!}
            />
            {allEntries.length > 0 && (
              <a
                href={entryHref(allEntries[0])}
                class="btn btn-primary flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg font-medium text-sm w-full"
              >
                <span>{isSectionCarnet ? t('diary.start') : t('diary.readFromBeginning')}</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
              </a>
            )}
            <OfflineDownload client:visible scopeType="carnet" scopeId={carnet!} language="original" />
          </div>
        </header>

        {/* Tag panels (remaining columns) */}
        {!isSectionCarnet && topPeople.length > 0 && (
          <div class="summary-card p-4 rounded-lg">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;">
              {t('diary.keyPeople')}
            </h3>
            <ul class="space-y-2">
              {topPeople.map(([personId, count]) => (
                <li class="flex items-center justify-between text-sm">
                  <a
                    href={glossaryUrl(lang, personId)}
                    class="text-ink hover:text-accent transition-colors truncate"
                  >
                    {formatDisplayName(personId)}
                  </a>
                  <span class="text-muted ml-2 flex-shrink-0">{count}x</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {!isSectionCarnet && topPlaces.length > 0 && (
          <div class="summary-card p-4 rounded-lg">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;">
              {t('diary.places')}
            </h3>
            <ul class="space-y-2">
              {topPlaces.map(([placeId, count]) => (
                <li class="flex items-center justify-between text-sm">
                  <a
                    href={glossaryUrl(lang, placeId)}
                    class="text-ink hover:text-accent transition-colors truncate"
                  >
                    {formatDisplayName(placeId)}
                  </a>
                  <span class="text-muted ml-2 flex-shrink-0">{count}x</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {!isSectionCarnet && topThemes.length > 0 && (
          <div class="summary-card p-4 rounded-lg">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;">
              {t('diary.themes')}
            </h3>
            <div class="flex flex-wrap gap-2">
              {topThemes.map(([theme, count]) => (
                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-sepia text-ink">
                  {theme}
                  <span class="text-muted">({count})</span>
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Calendar */}
        {!isSectionCarnet && calendarMonths.length > 0 && (
          <div class="summary-card p-4 rounded-lg xl:col-span-3 flex flex-col">
            <h3 class="text-sm font-medium text-muted uppercase mb-2" style="letter-spacing: 0.08em;">
              {t('diary.calendar')}
            </h3>
            <div class="flex flex-wrap gap-3 flex-1 items-start content-start">
              {calendarMonths.map(({ year, month }) => (
                <CalendarWidget
                  client:visible
                  year={year}
                  month={month}
                  entryDates={summary.entryDates}
                  carnet={carnet!}
                  language={calendarLanguage}
                  compact={true}
                />
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <FilterOverlay client:load pageType="carnet-detail" />

    <!-- Entry List -->
    <div class="space-y-2">
      {allEntries.map(entry => (
        <a
          href={entryHref(entry)}
          data-filter-entry={entry.date}
          class={`block p-4 rounded-lg border transition-all duration-200 ${
            lang.isTranslation && !entry.isTranslated
              ? 'bg-sepia/30 border-ink/5 hover:border-ink/20 hover:shadow-sm'
              : 'bg-parchment border-ink/10 hover:border-accent hover:shadow-md hover:-translate-y-px'
          }`}
        >
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <time class="text-ink font-medium" datetime={entry.date}>
                  {formatEntryDate(entry.date)}
                </time>
                {lang.isTranslation && !entry.isTranslated && (
                  <span class="text-xs px-2 py-0.5 bg-muted/20 text-muted rounded flex-shrink-0">
                    FR
                  </span>
                )}
              </div>
              {entry.preview && (
                <p class="mt-1 text-sm text-muted line-clamp-2">
                  {entry.preview}
                </p>
              )}
            </div>
            <svg class="w-5 h-5 text-muted flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </a>
      ))}
    </div>

    {allEntries.length === 0 && (
      <div class="text-center py-12 text-muted">
        <p>{t('diary.noEntries')}</p>
      </div>
    )}

    <!-- Carnet Navigation -->
    <nav class="mt-8 pt-8 border-t border-ink/10 flex justify-between items-center">
      {prevCarnet ? (
        <a
          href={`${basePath}/${prevCarnet.id}`}
          class="flex items-center gap-2 text-accent hover:text-accent-light transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span>{t('diary.notebook')} {prevCarnet.id}</span>
        </a>
      ) : (
        <div />
      )}

      {primaryYear ? (
        <a href={`${basePath}/${primaryYear}`} class="text-muted hover:text-ink transition-colors">
          {t('diary.year', { year: primaryYear })}
        </a>
      ) : (
        <a href={basePath} class="text-muted hover:text-ink transition-colors">
          {t('diary.overview')}
        </a>
      )}

      {nextCarnet ? (
        <a
          href={`${basePath}/${nextCarnet.id}`}
          class="flex items-center gap-2 text-accent hover:text-accent-light transition-colors"
        >
          <span>{t('diary.notebook')} {nextCarnet.id}</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      ) : (
        <div />
      )}
    </nav>
  </div>
</ReadingLayout>

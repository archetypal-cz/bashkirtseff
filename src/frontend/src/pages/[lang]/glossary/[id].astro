---
import ReadingLayout from '../../../layouts/ReadingLayout.astro';
import ParagraphMenu from '../../../components/reading/ParagraphMenu.vue';
import { getMergedGlossaryEntries, getGlossaryEntryWithFallback, buildGlossaryUsageCounts } from '../../../lib/content';
import { DIARY_LANGUAGES, type DiaryLanguageConfig } from '../../../lib/diary-lang-config';
import { createT } from '../../../i18n/astro';

export function getStaticPaths() {
  const paths: { params: { lang: string; id: string }; props: { lang: DiaryLanguageConfig; entryId: string } }[] = [];

  for (const lang of DIARY_LANGUAGES) {
    const entries = getMergedGlossaryEntries(lang.contentPath);
    for (const entry of entries) {
      paths.push({
        params: { lang: lang.urlPath, id: entry.id },
        props: { lang, entryId: entry.id },
      });
    }
  }

  return paths;
}

interface Props {
  lang: DiaryLanguageConfig;
  entryId: string;
}

const { lang, entryId } = Astro.props;
const t = createT(lang.uiLocale);
const basePath = `/${lang.urlPath}/glossary`;

// Load entry with fallback: try translated, fall back to original
const entry = getGlossaryEntryWithFallback(entryId, lang.contentPath);

if (!entry) {
  return Astro.redirect(basePath);
}

// Usage count and filter category for "Show in diary" button
const usageCounts = buildGlossaryUsageCounts();
const usageCount = usageCounts[entry.id] || 0;
const topCategory = (entry.category || '').split('/')[0];
const filterCategoryMap: Record<string, string> = { people: 'people', places: 'places', culture: 'culture' };
const filterCategory = filterCategoryMap[topCategory] || 'people';

// Simple markdown to HTML conversion for old format content
function simpleMarkdownToHtml(markdown: string): string {
  let html = markdown
    // Remove %% comment lines
    .replace(/%%[^%]*%%/g, '')
    // Headers
    .replace(/^### (.+)$/gm, '<h3 class="text-lg font-semibold text-ink mt-6 mb-3">$1</h3>')
    .replace(/^## (.+)$/gm, '<h2 class="text-xl font-semibold text-ink mt-8 mb-4">$1</h2>')
    .replace(/^# (.+)$/gm, '') // Remove H1 (we show it separately)
    // Bold
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    // Links - internal glossary links
    .replace(/\[([^\]]+)\]\(([^)]+\.md)\)/g, (_, text, url) => {
      const glossaryId = url.match(/([^/]+)\.md$/)?.[1];
      if (glossaryId) {
        return `<a href="${basePath}/${glossaryId}" class="text-accent hover:text-accent-light underline">${text}</a>`;
      }
      return text;
    })
    // Links - external
    .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" class="text-accent hover:text-accent-light underline">$1</a>')
    // Blockquotes
    .replace(/^>\s*(.+)$/gm, '<blockquote class="border-l-4 border-accent pl-4 my-4 italic text-ink-light">$1</blockquote>')
    // Lists
    .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
    // Paragraphs (simple version)
    .replace(/\n\n/g, '</p><p class="mb-4">')
    // Clean up metadata lines we don't want to display
    .replace(/<p class="mb-4"><strong>Research Status<\/strong>:[^<]+<\/p>/g, '')
    .replace(/<p class="mb-4"><strong>Last Updated<\/strong>:[^<]+<\/p>/g, '')
    .replace(/<p class="mb-4"><strong>Type<\/strong>:[^<]+<\/p>/g, '')
    .replace(/<p class="mb-4"><strong>Diary Coverage<\/strong>:[^<]+<\/p>/g, '')
    .replace(/<p class="mb-4"><strong>Full Research<\/strong>:[^<]+<\/p>/g, '');

  // Wrap lists
  html = html.replace(/(<li[^>]*>.*?<\/li>\s*)+/gs, '<ul class="list-disc mb-4">$&</ul>');

  return `<p class="mb-4">${html}</p>`;
}

// Prepare content for rendering
const hasParagraphs = entry.hasParagraphClusters && entry.paragraphs && entry.paragraphs.length > 0;
const processedParagraphs = hasParagraphs
  ? entry.paragraphs!.map(p => ({
      ...p,
      htmlId: `p-${p.id.replace(/\./g, '-')}`,
    }))
  : [];
const htmlContent = !hasParagraphs ? simpleMarkdownToHtml(entry.content) : '';

const diaryLabel = lang.isTranslation ? t('diary.diary') : 'Journal';
---

<ReadingLayout title={`${entry.name} â€” ${t('glossary.title')}`}>
  <article class="max-w-3xl mx-auto">
    <nav class="mb-6 text-sm text-muted">
      <a href={`/${lang.urlPath}`} class="hover:text-accent">{diaryLabel}</a>
      <span class="mx-2">&rsaquo;</span>
      <a href={basePath} class="hover:text-accent">{t('glossary.title')}</a>
      <span class="mx-2">&rsaquo;</span>
      <span class="text-ink">{entry.name}</span>
    </nav>

    <header class="mb-8 pb-6 border-b border-ink/10">
      <h1 class="text-2xl md:text-3xl font-normal text-ink mb-2" style="font-family: var(--font-serif);">
        {entry.name}
      </h1>

      {/* Original script and transliteration */}
      {(entry.originalScript || entry.transliteration) && (
        <p class="text-lg text-muted mb-4">
          {entry.originalScript && <span class="mr-3">{entry.originalScript}</span>}
          {entry.transliteration && entry.originalScript !== entry.transliteration && (
            <span class="italic">({entry.transliteration})</span>
          )}
        </p>
      )}

      {/* Aliases / alternate names */}
      {entry.aliases && entry.aliases.length > 0 && (
        <p class="text-sm text-muted mb-4 italic">
          {t('diary.alsoKnownAs')} {entry.aliases.join(', ')}
        </p>
      )}

      <div class="flex flex-wrap items-center gap-3 text-sm">
        {entry.type && (
          <span class="px-3 py-1 bg-accent text-white rounded">
            {entry.type}
          </span>
        )}
        {entry.category && (
          <span class="px-3 py-1 bg-sepia text-ink-light rounded">
            {entry.category}
          </span>
        )}
        {entry.languages && entry.languages.length > 0 && (
          <span class="px-3 py-1 bg-sepia text-ink-light rounded">
            {entry.languages.map(l => l.toUpperCase()).join(' / ')}
          </span>
        )}
        {entry.researchStatus && (
          <span class="px-3 py-1 bg-sepia text-ink-light rounded">
            {entry.researchStatus}
          </span>
        )}
        {entry.pronunciation && (
          <a
            href={entry.pronunciation}
            target="_blank"
            rel="noopener"
            class="px-3 py-1 bg-accent/10 text-accent rounded hover:bg-accent/20 transition-colors"
            title={t('glossary.pronunciationTitle')}
          >
            {t('glossary.pronunciation')}
          </a>
        )}
        {entry.lastUpdated && (
          <span class="text-muted">
            {t('glossary.updated')}: {entry.lastUpdated}
          </span>
        )}
      </div>

      {usageCount > 0 && (
        <a
          href={`/${lang.urlPath}`}
          class="glossary-filter-btn"
          data-filter-category={filterCategory}
          data-filter-id={entry.id}
        >
          <svg class="glossary-filter-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          {t('diary.showInDiary')}
          <span class="glossary-filter-count">{t('diary.mentions', { count: usageCount })}</span>
        </a>
      )}
    </header>

    {/* Render with paragraph clusters if available */}
    {hasParagraphs ? (
      <div class="prose-diary space-y-6">
        {processedParagraphs.map(paragraph => (
          <div
            id={paragraph.htmlId}
            class="group relative paragraph-container scroll-mt-24"
            data-paragraph-id={paragraph.id}
          >
            {paragraph.isHeader ? (
              paragraph.headerLevel === 1 ? (
                <h1 class="text-2xl font-normal text-ink mb-4" set:html={paragraph.html} />
              ) : paragraph.headerLevel === 2 ? (
                <h2 class="text-xl font-semibold text-ink mt-8 mb-4" set:html={paragraph.html} />
              ) : (
                <h3 class="text-lg font-semibold text-ink mt-6 mb-3" set:html={paragraph.html} />
              )
            ) : (
              <p class="text-lg leading-relaxed text-ink" set:html={paragraph.html} />
            )}

            {/* Paragraph menu */}
            <div class="absolute -top-3 right-0 opacity-50 hover:opacity-100 group-hover:opacity-100 transition-opacity z-10">
              <ParagraphMenu
                client:visible
                paragraphId={paragraph.id}
                glossaryTags={paragraph.glossaryTags}
                {...(lang.isTranslation ? { language: lang.urlPath } : {})}
              />
            </div>
          </div>
        ))}
      </div>
    ) : (
      /* Fall back to simple HTML rendering for old format */
      <div class="prose-diary" set:html={htmlContent} />
    )}

    <nav class="mt-12 pt-8 border-t border-ink/10">
      <a href={basePath} class="text-accent hover:text-accent-light transition-colors">
        &larr; {t('glossary.backToGlossary')}
      </a>
    </nav>
  </article>
</ReadingLayout>

<script is:inline define:vars={{ __glossaryHistoryJSON: JSON.stringify({
  glossaryId: entryId,
  glossaryName: entry?.name || entryId,
  language: lang.urlPath,
  url: `/${lang.urlPath}/glossary/${entryId}`,
}) }}>
  // Record glossary visit for reading history
  document.addEventListener('DOMContentLoaded', () => {
    const data = JSON.parse(__glossaryHistoryJSON);
    window.dispatchEvent(new CustomEvent('glossary-visit', { detail: data }));
  });
</script>

<script>
  // Handle deep linking - highlight paragraph on page load
  document.addEventListener('DOMContentLoaded', () => {
    const hash = window.location.hash;
    if (hash) {
      const element = document.querySelector(hash);
      if (element) {
        element.classList.add('paragraph-highlight');
        setTimeout(() => {
          element.classList.remove('paragraph-highlight');
        }, 2000);
      }
    }

    // Filter button: set filter-tags in localStorage and navigate
    document.querySelectorAll('.glossary-filter-btn').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const category = el.getAttribute('data-filter-category');
        const id = el.getAttribute('data-filter-id');
        if (category && id) {
          localStorage.setItem('filter-tags', JSON.stringify({ [category]: [id] }));
          window.dispatchEvent(new CustomEvent('filter-sync'));
        }
        window.location.href = el.getAttribute('href');
      });
    });
  });
</script>

<style is:global>
  .glossary-filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-accent, #B45309);
    background: transparent;
    border: 1px solid var(--color-accent, #B45309);
    border-radius: 0.5rem;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s;
  }

  .glossary-filter-btn:hover {
    background: var(--color-accent, #B45309);
    color: white;
  }

  .glossary-filter-icon {
    width: 1rem;
    height: 1rem;
  }

  .glossary-filter-count {
    font-size: 0.75rem;
    font-weight: 400;
    opacity: 0.8;
  }

  [data-theme="dark"] .glossary-filter-btn {
    color: var(--color-accent-light, #D97706);
    border-color: var(--color-accent-light, #D97706);
  }

  [data-theme="dark"] .glossary-filter-btn:hover {
    background: var(--color-accent-light, #D97706);
    color: #1a1a1a;
  }

  .prose-diary h2 {
    font-family: var(--font-serif);
  }

  .prose-diary h3 {
    font-family: var(--font-serif);
  }

  .prose-diary blockquote {
    font-family: var(--font-serif);
  }

  .prose-diary ul {
    padding-left: 1.5rem;
  }

  .prose-diary li {
    margin-bottom: 0.5rem;
  }
</style>

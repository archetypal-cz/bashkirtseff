---
import ReadingLayout from '../../../layouts/ReadingLayout.astro';
import { getMergedGlossaryEntries } from '../../../lib/content';
import { DIARY_LANGUAGES, type DiaryLanguageConfig } from '../../../lib/diary-lang-config';
import { createT } from '../../../i18n/astro';
import type { GlossaryEntry } from '../../../lib/content';

export function getStaticPaths() {
  const paths: { params: { lang: string; letter: string }; props: { lang: DiaryLanguageConfig; letter: string; entries: GlossaryEntry[] } }[] = [];

  for (const lang of DIARY_LANGUAGES) {
    const allEntries = getMergedGlossaryEntries(lang.contentPath);

    // Group by letter
    const byLetter = new Map<string, GlossaryEntry[]>();
    for (const entry of allEntries) {
      const letter = entry.name.charAt(0).toUpperCase();
      if (!byLetter.has(letter)) {
        byLetter.set(letter, []);
      }
      byLetter.get(letter)!.push(entry);
    }

    for (const [letter, entries] of byLetter) {
      paths.push({
        params: { lang: lang.urlPath, letter: letter.toLowerCase() },
        props: { lang, letter: letter.toUpperCase(), entries },
      });
    }
  }

  return paths;
}

interface Props {
  lang: DiaryLanguageConfig;
  letter: string;
  entries: GlossaryEntry[];
}

const { lang, letter, entries } = Astro.props;
const t = createT(lang.uiLocale);
const basePath = `/${lang.urlPath}/glossary`;

// Get all letters for navigation
const allEntries = getMergedGlossaryEntries(lang.contentPath);
const allLettersSet = new Set<string>();
for (const entry of allEntries) {
  allLettersSet.add(entry.name.charAt(0).toUpperCase());
}
const allLetters = Array.from(allLettersSet).sort();

const diaryLabel = lang.isTranslation ? t('diary.diary') : 'Journal';

// Entry count label
function entryCountLabel(count: number): string {
  if (count === 1) return `1 ${t('glossary.entry1')}`;
  if (count >= 2 && count <= 4) return `${count} ${t('glossary.entries2to4')}`;
  return `${count} ${t('glossary.entries')}`;
}
---

<ReadingLayout title={`${letter} â€” ${t('glossary.title')}`} lang={lang.urlPath}>
  <div class="max-w-4xl mx-auto">
    <header class="mb-8">
      <nav class="mb-6 text-sm text-muted">
        <a href={`/${lang.urlPath}`} class="hover:text-accent">{diaryLabel}</a>
        <span class="mx-2">&rsaquo;</span>
        <a href={basePath} class="hover:text-accent">{t('glossary.title')}</a>
        <span class="mx-2">&rsaquo;</span>
        <span class="text-ink">{letter}</span>
      </nav>

      <h1 class="text-3xl font-normal text-ink mb-4" style="font-family: var(--font-serif);">
        {letter}
      </h1>
      <p class="text-sm text-muted">
        {entryCountLabel(entries.length)}
      </p>
    </header>

    <!-- Letter navigation -->
    <nav class="mb-8 flex flex-wrap gap-2">
      {allLetters.map(l => (
        <a
          href={`${basePath}/${l.toLowerCase()}`}
          class:list={[
            "w-8 h-8 flex items-center justify-center rounded text-sm font-medium transition-colors",
            l === letter
              ? "bg-accent text-white"
              : "bg-sepia text-ink hover:bg-accent hover:text-white"
          ]}
        >
          {l}
        </a>
      ))}
    </nav>

    <!-- Entries for this letter -->
    <div class="grid gap-3">
      {entries.map(entry => (
        <a
          href={`${basePath}/${entry.id}`}
          class="block p-4 bg-parchment rounded-lg border border-ink/10 hover:border-accent hover:shadow transition-all"
        >
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <h3 class="text-lg text-ink font-medium truncate">
                {entry.name}
              </h3>
              {entry.type && (
                <span class="text-xs px-2 py-0.5 bg-sepia rounded text-muted mt-1 inline-block">
                  {entry.type}
                </span>
              )}
              {entry.summary && (
                <p class="text-sm text-muted mt-2 line-clamp-2">
                  {entry.summary}
                </p>
              )}
            </div>
            <svg class="w-5 h-5 text-muted flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </a>
      ))}
    </div>

    {entries.length === 0 && (
      <div class="text-center py-12 text-muted">
        <p>{t('glossary.noEntriesForLetter')}</p>
      </div>
    )}
  </div>
</ReadingLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

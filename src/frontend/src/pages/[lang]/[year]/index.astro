---
import ReadingLayout from '../../../layouts/ReadingLayout.astro';
import ContentLanguageSwitcher from '../../../components/reading/ContentLanguageSwitcher.vue';
import ContinueReading from '../../../components/reading/ContinueReading.vue';
import FilterOverlay from '../../../components/filter/FilterOverlay.vue';
import OfflineDownload from '../../../components/pwa/OfflineDownload.vue';
import { getYears, getCarnetsByYear, getYearInfo, getYearSummary, isCarnetCrossYear } from '../../../lib/content';
import { DIARY_LANGUAGES, glossaryUrl, type DiaryLanguageConfig } from '../../../lib/diary-lang-config';
import { createT } from '../../../i18n/astro';

export function getStaticPaths() {
  const paths: { params: { lang: string; year: string }; props: { lang: DiaryLanguageConfig } }[] = [];
  const years = getYears('_original');

  for (const lang of DIARY_LANGUAGES) {
    for (const yearInfo of years) {
      paths.push({
        params: { lang: lang.urlPath, year: String(yearInfo.year) },
        props: { lang },
      });
    }
  }

  return paths;
}

interface Props {
  lang: DiaryLanguageConfig;
}

const { lang } = Astro.props;
const { year } = Astro.params;
const yearNum = parseInt(year!, 10);
const t = createT(lang.uiLocale);
const basePath = `/${lang.urlPath}`;

const yearInfo = getYearInfo(yearNum, '_original');
const originalCarnetsInYear = getCarnetsByYear(yearNum, '_original');

// For translations: merge language-specific + original carnets
// For original: just original carnets
let allCarnetIds: string[];
let langCarnetsInYear: ReturnType<typeof getCarnetsByYear> = [];

if (lang.isTranslation) {
  langCarnetsInYear = getCarnetsByYear(yearNum, lang.contentPath);
  allCarnetIds = [...new Set([
    ...langCarnetsInYear.map(c => c.id),
    ...originalCarnetsInYear.map(c => c.id),
  ])].sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
} else {
  allCarnetIds = originalCarnetsInYear.map(c => c.id).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
}

// Build carnet info with optional translation status
const carnetsWithStatus = allCarnetIds.map(carnetId => {
  const langCarnet = langCarnetsInYear.find(c => c.id === carnetId);
  const origCarnet = originalCarnetsInYear.find(c => c.id === carnetId);
  const carnet = langCarnet || origCarnet!;

  const origEntries = origCarnet?.entries || [];
  const langEntries = langCarnet?.entries || [];
  const crossYear = isCarnetCrossYear(carnetId, '_original');

  return {
    id: carnetId,
    entriesInYear: origEntries.length,
    translatedCount: lang.isTranslation ? langEntries.length : 0,
    dateRange: carnet.dateRange,
    crossYear: crossYear.crossYear,
    allYears: crossYear.years,
  };
});

const totalEntries = carnetsWithStatus.reduce((sum, c) => sum + c.entriesInYear, 0);
const totalTranslated = lang.isTranslation
  ? carnetsWithStatus.reduce((sum, c) => sum + c.translatedCount, 0)
  : 0;

const formatDateRange = (start: Date, end: Date) => {
  const startStr = start.toLocaleDateString(lang.dateLocale, { day: 'numeric', month: 'short' });
  const endStr = end.toLocaleDateString(lang.dateLocale, { day: 'numeric', month: 'short' });
  return `${startStr} – ${endStr}`;
};

// Year navigation
const allYears = getYears('_original');
const currentIndex = allYears.findIndex(y => y.year === yearNum);
const prevYear = currentIndex > 0 ? allYears[currentIndex - 1] : null;
const nextYear = currentIndex < allYears.length - 1 ? allYears[currentIndex + 1] : null;

const diaryLabel = lang.isTranslation ? t('diary.diary') : 'Journal';

// Year summary data (people, places, themes)
const summary = await getYearSummary(yearNum, '_original');
const topPeople = Object.entries(summary.peopleCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topPlaces = Object.entries(summary.placesCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
const topThemes = Object.entries(summary.themeCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

function formatDisplayName(id: string): string {
  return id.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}
---

<ReadingLayout title={`${t('diary.year', { year })} — ${t('diary.pageTitle')}`} lang={lang.urlPath}>
  <div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm text-muted">
      <a href={basePath} class="hover:text-accent">
        {lang.isTranslation ? (
          <span data-t="diary.diary">{diaryLabel}</span>
        ) : (
          <span>Journal</span>
        )}
      </a>
      <span class="mx-2">&rsaquo;</span>
      <span class="text-ink" data-t="diary.year" data-t-params={JSON.stringify({ year })}>{t('diary.year', { year })}</span>
    </nav>

    <!-- Header + Summary Grid -->
    <section class="mb-10">
      <div class="grid gap-5 grid-cols-1 sm:grid-cols-2 xl:grid-cols-[1.5fr_1fr_1fr]">
        <!-- Year Header (wider 1st column) -->
        <header class="summary-card p-5 rounded-lg flex flex-col justify-between">
          <div>
            <h1 class="text-3xl font-normal text-ink mb-3" style="font-family: var(--font-serif); text-shadow: 0 1px 2px rgba(44,24,16,0.08);">
              {t('diary.year', { year })}
            </h1>

            {yearInfo && (
              <p class="text-ink-light mb-3">
                Marie Bashkirtseff ({yearInfo.marieAge} <span data-t="home.yearsOld">{t('home.yearsOld')}</span>)
              </p>
            )}

            <div class="flex items-center gap-3 text-sm mb-3">
              <span class="text-muted">
                {carnetsWithStatus.length} <span data-t="diary.notebooks">{t('diary.notebooks')}</span>
              </span>
              <span class="text-muted">&bull;</span>
              <span class="text-muted">
                {totalEntries} <span data-t="diary.entries">{t('diary.entries')}</span>
              </span>
              {lang.isTranslation && (
                <>
                  <span class="text-muted">&bull;</span>
                  <span class="text-accent">
                    {totalTranslated} <span data-t="diary.translated">{t('diary.translated')}</span>
                  </span>
                </>
              )}
            </div>

            {lang.isTranslation && totalTranslated < totalEntries && (
              <div class="mb-4">
                <div class="h-2 bg-sepia rounded-full overflow-hidden">
                  <div
                    class="h-full bg-accent rounded-full transition-all"
                    style={`width: ${(totalTranslated / totalEntries) * 100}%`}
                  />
                </div>
                <p class="text-xs text-muted mt-1" data-t="diary.completed" data-t-params={JSON.stringify({ percent: Math.round((totalTranslated / totalEntries) * 100) })}>
                  {t('diary.completed', { percent: Math.round((totalTranslated / totalEntries) * 100) })}
                </p>
              </div>
            )}

            {summary.primaryLocation && (
              <p class="text-sm text-muted mb-2">
                <span data-t="diary.mainLocation">{t('diary.mainLocation')}</span> <a href={glossaryUrl(lang, summary.primaryLocation.toUpperCase().replace(/ /g, '_'))} class="text-ink hover:text-accent transition-colors">{formatDisplayName(summary.primaryLocation)}</a>
              </p>
            )}
          </div>

          <div class="flex flex-col gap-3 mt-4">
            <ContentLanguageSwitcher
              client:load
              currentLanguage={lang.urlPath}
              pathSuffix={`/${year}/`}
            />
            <ContinueReading
              client:load
              scopeType="year"
              scopeId={year!}
            />
            <OfflineDownload client:visible scopeType="year" scopeId={year!} language="original" />
          </div>
        </header>

        {/* Key People */}
        {topPeople.length > 0 && (
          <div class="summary-card p-4 rounded-lg">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;" data-t="diary.keyPeople">
              {t('diary.keyPeople')}
            </h3>
            <ul class="space-y-2">
              {topPeople.map(([personId, count]) => (
                <li class="flex items-center justify-between text-sm">
                  <a
                    href={glossaryUrl(lang, personId)}
                    class="text-ink hover:text-accent transition-colors truncate"
                  >
                    {formatDisplayName(personId)}
                  </a>
                  <span class="text-muted ml-2 flex-shrink-0">{count}x</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Places */}
        {topPlaces.length > 0 && (
          <div class="summary-card p-4 rounded-lg">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;" data-t="diary.places">
              {t('diary.places')}
            </h3>
            <ul class="space-y-2">
              {topPlaces.map(([placeId, count]) => (
                <li class="flex items-center justify-between text-sm">
                  <a
                    href={glossaryUrl(lang, placeId)}
                    class="text-ink hover:text-accent transition-colors truncate"
                  >
                    {formatDisplayName(placeId)}
                  </a>
                  <span class="text-muted ml-2 flex-shrink-0">{count}x</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Themes (spans full width) */}
        {topThemes.length > 0 && (
          <div class="summary-card p-4 rounded-lg sm:col-span-2 xl:col-span-3">
            <h3 class="text-sm font-medium text-muted uppercase mb-3" style="letter-spacing: 0.08em;" data-t="diary.themes">
              {t('diary.themes')}
            </h3>
            <div class="flex flex-wrap gap-2">
              {topThemes.map(([theme, count]) => (
                <span class="inline-flex items-center gap-1 px-2 py-1 text-xs rounded-full bg-sepia text-ink">
                  {theme}
                  <span class="text-muted">({count})</span>
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- Year Navigation -->
    <nav class="flex justify-between items-center mb-8 text-sm">
      {prevYear ? (
        <a href={`${basePath}/${prevYear.year}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {prevYear.year}
        </a>
      ) : <span />}
      <a href={basePath} class="text-muted hover:text-ink transition-colors flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
        {lang.isTranslation ? (
          <span data-t="diary.diary">{diaryLabel}</span>
        ) : (
          <span>Journal</span>
        )}
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
      </a>
      {nextYear ? (
        <a href={`${basePath}/${nextYear.year}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
          {nextYear.year}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      ) : <span />}
    </nav>

    <FilterOverlay client:load pageType="year-detail" />

    <!-- Carnet List (masonry) -->
    <div class="masonry-carnets">
      {carnetsWithStatus.map(carnet => (
        <a
          href={`${basePath}/${carnet.id}`}
          data-filter-carnet={carnet.id}
          class={`block p-4 rounded-lg border transition-all ${
            lang.isTranslation && carnet.translatedCount === 0
              ? 'bg-sepia/30 border-ink/5 hover:border-ink/20'
              : 'bg-parchment border-ink/10 hover:border-accent hover:shadow'
          }`}
        >
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3">
                <span class="text-ink font-medium">
                  <span data-t="diary.notebook">{t('diary.notebook')}</span> {carnet.id}
                </span>
                {carnet.crossYear && (
                  <span class="text-xs px-2 py-0.5 bg-amber-100 text-amber-700 rounded" title={t('diary.crossYearContinues', { years: carnet.allYears.filter(y => y !== yearNum).join(', ') })}>
                    {carnet.allYears[0] < yearNum ? `← ${carnet.allYears[0]}` : ''}
                    {carnet.allYears[carnet.allYears.length - 1] > yearNum ? `→ ${carnet.allYears[carnet.allYears.length - 1]}` : ''}
                  </span>
                )}
                {lang.isTranslation && carnet.translatedCount === 0 && (
                  <span class="text-xs px-2 py-0.5 bg-muted/20 text-muted rounded">
                    FR
                  </span>
                )}
              </div>
              {carnet.dateRange && (
                <p class="text-sm text-muted mt-1">
                  {formatDateRange(carnet.dateRange.start, carnet.dateRange.end)}
                  <span class="mx-2">&bull;</span>
                  <span data-filter-count={`carnet-entries:${carnet.id}`}>{carnet.entriesInYear}</span> <span data-t="diary.entries">{t('diary.entries')}</span>
                  {lang.isTranslation && carnet.translatedCount > 0 && carnet.translatedCount < carnet.entriesInYear && (
                    <span class="text-accent ml-1">
                      ({carnet.translatedCount} <span data-t="diary.translated">{t('diary.translated')}</span>)
                    </span>
                  )}
                </p>
              )}
            </div>
            <svg class="w-5 h-5 text-muted flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </a>
      ))}
    </div>

    {carnetsWithStatus.length === 0 && (
      <div class="text-center py-12 text-muted">
        <p data-t="diary.noCarnetsFound">{t('diary.noCarnetsFound')}</p>
      </div>
    )}

    <!-- Bottom navigation (mirrors top nav) -->
    <nav class="mt-8 pt-8 border-t border-ink/10 flex justify-between items-center text-sm">
      {prevYear ? (
        <a href={`${basePath}/${prevYear.year}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          {prevYear.year}
        </a>
      ) : <span />}
      <a href={basePath} class="text-muted hover:text-ink transition-colors flex items-center gap-1">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
        {lang.isTranslation ? (
          <span data-t="diary.diary">{diaryLabel}</span>
        ) : (
          <span>Journal</span>
        )}
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
      </a>
      {nextYear ? (
        <a href={`${basePath}/${nextYear.year}`} class="text-accent hover:text-accent-light transition-colors flex items-center gap-1">
          {nextYear.year}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      ) : <span />}
    </nav>
  </div>
</ReadingLayout>

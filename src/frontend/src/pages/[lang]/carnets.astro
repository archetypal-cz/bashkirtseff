---
import ReadingLayout from '../../layouts/ReadingLayout.astro';
import FilterOverlay from '../../components/filter/FilterOverlay.vue';
import { getCarnets } from '../../lib/content';
import { DIARY_LANGUAGES, type DiaryLanguageConfig } from '../../lib/diary-lang-config';
import { createT } from '../../i18n/astro';

// Only generate for translation languages (flat carnet list is a translation feature)
export function getStaticPaths() {
  return DIARY_LANGUAGES
    .filter(lang => lang.isTranslation)
    .map(lang => ({
      params: { lang: lang.urlPath },
      props: { lang },
    }));
}

interface Props {
  lang: DiaryLanguageConfig;
}

const { lang } = Astro.props;
const t = createT(lang.uiLocale);
const basePath = `/${lang.urlPath}`;

const langCarnets = getCarnets(lang.contentPath);
const originalCarnets = getCarnets('_original');

// Merge: show all original carnets, mark which have translations
const allCarnets = originalCarnets.map(orig => {
  const langCarnet = langCarnets.find(c => c.id === orig.id);
  return {
    ...orig,
    hasTranslation: !!langCarnet,
    translatedEntries: langCarnet?.entries.length || 0,
    totalEntries: orig.entries.length,
  };
});

const formatDate = (date: Date) => {
  return date.toLocaleDateString(lang.dateLocale, {
    year: 'numeric',
    month: 'long',
  });
};

const totalEntries = allCarnets.reduce((sum, c) => sum + c.totalEntries, 0);
const totalTranslated = allCarnets.reduce((sum, c) => sum + c.translatedEntries, 0);
---

<ReadingLayout title={`${t('diary.allNotebooks')} — ${t('diary.pageTitle')}`} lang={lang.urlPath}>
  <div class="max-w-4xl mx-auto">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm text-muted">
      <a href={basePath} class="hover:text-accent">{t('diary.diary')}</a>
      <span class="mx-2">&rsaquo;</span>
      <span class="text-ink">{t('diary.allNotebooks')}</span>
    </nav>

    <header class="mb-12">
      <h1 class="text-3xl font-normal text-ink mb-4" style="font-family: var(--font-serif);">
        {t('diary.allNotebooks')}
      </h1>

      <div class="flex items-center gap-6 text-sm text-muted">
        <span>{allCarnets.length} sešitů</span>
        <span>&bull;</span>
        <span>{totalEntries} {t('diary.entries')}</span>
        <span>&bull;</span>
        <span class="text-accent">{totalTranslated} {t('diary.translated')}</span>
      </div>

      {totalTranslated < totalEntries && (
        <div class="mt-4 max-w-md">
          <div class="h-2 bg-sepia rounded-full overflow-hidden">
            <div
              class="h-full bg-accent rounded-full transition-all"
              style={`width: ${(totalTranslated / totalEntries) * 100}%`}
            />
          </div>
          <p class="text-xs text-muted mt-1">
            {t('diary.completed', { percent: Math.round((totalTranslated / totalEntries) * 100) })}
          </p>
        </div>
      )}
    </header>

    <FilterOverlay client:load pageType="carnets-list" />

    <div class="grid gap-4">
      {allCarnets.map(carnet => (
        <a
          href={carnet.hasTranslation ? `${basePath}/${carnet.id}` : `/original/${carnet.id}`}
          data-filter-carnet={carnet.id}
          class={`block p-4 rounded-lg border transition-all ${
            carnet.hasTranslation
              ? 'bg-parchment border-ink/10 hover:border-accent hover:shadow'
              : 'bg-sepia/30 border-ink/5 hover:border-ink/20'
          }`}
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <span class="text-xl font-light text-accent w-12">
                {carnet.id}
              </span>
              <div>
                <span class="text-ink">
                  {t('diary.notebook')} {carnet.id}
                </span>
                {!carnet.hasTranslation && (
                  <span class="ml-2 text-xs px-2 py-0.5 bg-muted/20 text-muted rounded">
                    FR
                  </span>
                )}
                {carnet.dateRange && (
                  <p class="text-sm text-muted">
                    {formatDate(carnet.dateRange.start)} — {formatDate(carnet.dateRange.end)}
                  </p>
                )}
              </div>
            </div>

            <div class="text-right flex items-center gap-4">
              {carnet.hasTranslation && carnet.translatedEntries < carnet.totalEntries && (
                <div class="w-24">
                  <div class="h-1 bg-sepia rounded-full overflow-hidden">
                    <div
                      class="h-full bg-accent rounded-full"
                      style={`width: ${(carnet.translatedEntries / carnet.totalEntries) * 100}%`}
                    />
                  </div>
                  <p class="text-xs text-muted mt-0.5">
                    {carnet.translatedEntries}/{carnet.totalEntries}
                  </p>
                </div>
              )}
              <div class="text-sm text-muted">
                {carnet.totalEntries} {t('diary.entries')}
              </div>
              <svg class="w-5 h-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </div>
        </a>
      ))}
    </div>

    {allCarnets.length === 0 && (
      <div class="text-center py-12 text-muted">
        <p>{t('diary.noCarnetsFound')}</p>
      </div>
    )}

    <!-- Back link -->
    <div class="mt-8 pt-8 border-t border-ink/10">
      <a href={basePath} class="text-accent hover:text-accent-light transition-colors">
        &larr; {t('diary.allNotebooks')}
      </a>
    </div>
  </div>
</ReadingLayout>
